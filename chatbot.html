<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Troppion Chatbot AI</title>
  
  
  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700&family=Roboto:wght@400;500&display=swap" rel="stylesheet">
  
  <style>
    :root {
      --bg: #0a0a0a;
      --bg-elev: #111214;
      --panel: #0f1012;
      --border: #2a2a2a;
      --text: #e6e6e6;
      --muted: #9aa0a6;
      --accent: #10a37f; /* ring fokus ala OpenAI */
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: 'Roboto', system-ui, -apple-system, Segoe UI, Helvetica, Arial, sans-serif;
      font-size:16px; line-height:1.6; color:var(--text);
      background: var(--bg);
    }

    /* ===== APP CONTAINER ===== */
    .app{ max-width:960px; margin:0 auto; min-height:100dvh; display:grid; grid-template-rows:auto 1fr auto; padding-inline:12px }
    header{ position:sticky; top:0; z-index:10; display:flex; align-items:center; justify-content:space-between; gap:12px; padding:14px 16px; background:var(--bg); border-bottom:1px solid var(--border) }
    h1{ margin:0; font-family: 'Montserrat', system-ui, sans-serif; font-weight:700; font-size:18px; letter-spacing:.2px }
    .actions{ display:flex; align-items:center; gap:8px; flex-wrap:wrap }
    .ghost{ background: var(--bg-elev); color:var(--text); border:1px solid var(--border); padding:8px 10px; border-radius:10px; transition: background .15s ease, border-color .15s ease }
    .ghost:hover{ background:#15171a; border-color:#333 }
    select.ghost{ cursor:pointer }

    /* ===== CHAT CONTAINER ===== */
    .shell{ margin:14px 0; border:1px solid var(--border); border-radius:14px; padding:0; background:var(--panel) }
    .panel{ border-radius:inherit; background:var(--panel) }
    .chat{ padding:16px 18px 22px; overflow:auto; display:flex; flex-direction:column; gap:12px }

    .msg{ display:grid; grid-template-columns:40px 1fr; gap:10px; align-items:flex-start; opacity:0; transform:translateY(6px); animation:fadein .18s ease-out forwards }
    .avatar{ width:40px; height:40px; display:grid; place-items:center; font-size:20px; background:var(--bg-elev); border:1px solid var(--border); border-radius:10px }
    .bubble{ background:var(--panel); border:1px solid var(--border); border-radius:12px; padding:12px 14px; overflow:hidden }
    .msg.user .bubble{ border-color:#343434 }

    .content :is(p,ul,ol){ margin:.4em 0 }
    .content a{ color:#cfd3d6; text-decoration:none; border-bottom:1px dashed #6b728044 }
    .content code{ background:#0c0d0f; border:1px solid var(--border); padding:2px 6px; border-radius:8px }
    .content pre{ background:#0c0d0f; border:1px solid var(--border); padding:10px; border-radius:12px; overflow:auto }

    .typing{ color:var(--muted); font-style:italic; margin-left:50px; display:flex; align-items:center; gap:8px }
    .typing .dot{ width:6px; height:6px; border-radius:50%; background:#6b7280; opacity:.6; animation:blink 1.2s infinite }
    .typing .dot:nth-child(2){ animation-delay:.2s }
    .typing .dot:nth-child(3){ animation-delay:.4s }

    form.input{ display:grid; grid-template-columns:1fr auto; gap:8px; padding:12px 14px; background:var(--bg); border-top:1px solid var(--border) }
    form.input input[type="text"], form.input input:not([type]){ background:var(--bg-elev); color:var(--text); border:1px solid var(--border); border-radius:12px; padding:12px 14px; outline:none; transition:border-color .15s, box-shadow .15s }
    form.input input:focus{ border-color:#3a3a3a; box-shadow:0 0 0 3px rgba(16,163,127,.25) }
    form.input input::placeholder{ color:#8b9096 }
    form.input button{ background:#1f1f1f; color:#fff; border:1px solid #2a2a2a; border-radius:12px; padding:0 18px; font-weight:600; letter-spacing:.2px; cursor:pointer; transition:background .15s, transform .06s, border-color .15s }
    form.input button:hover{ background:#2a2a2a; border-color:#3a3a3a }
    form.input button:active{ transform:translateY(1px) }
    form.input button:disabled{ opacity:.6; cursor:not-allowed }

    @media (max-width:640px){ header{ padding:12px } .chat{ padding:12px } form.input{ padding:12px } }

    /* ===== ANIMASI HALUS ===== */
    @keyframes fadein{ from{ opacity:0; transform:translateY(6px) } to{ opacity:1; transform:translateY(0) } }
    @keyframes blink{ 0%,80%,100%{ opacity:.2 } 40%{ opacity:1 } }

    /* ===== MATIKAN DEKOR WARNA ===== */
    .decor{ display:none !important }
  </style>
</head>


<body>
  <div class="orb orb2"></div>
    <div class="orb orb3"></div>
  </div>
  <div id="root"></div>

  <!-- React 18 + ReactDOM UMD -->
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <!-- Babel for in-browser JSX transform -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <!-- marked UMD -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <script type="text/babel">
    const { useEffect, useRef, useState } = React;

    function App() {
      const [messages, setMessages] = useState([
        { role: "assistant", content: "Halo! Saya Troppion AI. Tanyakan apa saja, dan kamu bisa unggah gambar juga." },
      ]);
      const [input, setInput] = useState("");
      const [isLoading, setIsLoading] = useState(false);
      const [style, setStyle] = useState("comprehensive");
      const [files, setFiles] = useState([]); // simpan File[] untuk preview & upload
      const listRef = useRef(null);
      const abortRef = useRef(null);

      useEffect(() => {
        listRef.current?.scrollTo({ top: listRef.current.scrollHeight, behavior: "smooth" });
      }, [messages, isLoading]);

      function onPickFiles(e) {
        const picked = Array.from(e.target.files || []);
        // filter tipe dan batasi jumlah
        const allowed = ["image/png", "image/jpeg", "image/webp"];
        const next = picked.filter(f => allowed.includes(f.type)).slice(0, 5);
        setFiles(prev => [...prev, ...next].slice(0, 5));
        e.target.value = ""; // reset agar bisa pilih file yang sama lagi jika perlu
      }

      function removeFile(idx) {
        setFiles(prev => prev.filter((_, i) => i !== idx));
      }

      function fileToBase64(file) {
        return new Promise((resolve, reject) => {
          const fr = new FileReader();
          fr.onload = () => {
            const dataUrl = fr.result; // "data:image/png;base64,AAAA..."
            const base64 = String(dataUrl).split(",")[1] || "";
            resolve({ mime: file.type, data: base64 });
          };
          fr.onerror = reject;
          fr.readAsDataURL(file);
        });
      }

      function stopStreaming() {
        try { abortRef.current?.abort(); } catch {}
        abortRef.current = null;
        setIsLoading(false);
        setMessages(prev => [...prev, { role: "assistant", content: "⏹️ Dihentikan." }]);
      }

      async function sendMessage(e) {
        e.preventDefault();
        const text = input.trim();
        if (!text && files.length === 0) return;

        setInput("");
        setIsLoading(true);
        // tampilkan pesan user (teks saja biar rapi; gambar akan dipreview terpisah)
        if (text) setMessages(prev => [...prev, { role: "user", content: text }]);

        // convert semua files ke base64
        let packedImages = [];
        try {
          packedImages = await Promise.all(files.map(fileToBase64));
        } catch (err) {
          setIsLoading(false);
          setMessages(prev => [...prev, { role: "assistant", content: `⚠️ Gagal membaca gambar: ${err?.message || err}` }]);
          return;
        }
        // reset file list setelah terkirim
        setFiles([]);

        // streaming SSE
        const ac = new AbortController();
        abortRef.current = ac;

        try {
          const res = await fetch("/api/chat", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              message: text,
              images: packedImages,      // kirim ke server
              sessionId: "troppion",
              answerStyle: style,
              temperature: 0.3
            }),
            signal: ac.signal,
          });

          if (!res.ok || !res.body) {
            const errText = await res.text().catch(() => "");
            throw new Error(errText || `HTTP ${res.status}`);
          }

          const reader = res.body.getReader();
          const decoder = new TextDecoder();
          let sseBuffer = "";
          let ai = "";

          // siapkan bubble assistant kosong
          setMessages(prev => [...prev, { role: "assistant", content: "" }]);

          while (true) {
            const { value, done } = await reader.read();
            if (done) break;

            sseBuffer += decoder.decode(value, { stream: true });
            const parts = sseBuffer.split("\n\n");
            sseBuffer = parts.pop() || "";

            for (const part of parts) {
              const line = part.trim();
              if (!line.startsWith("data:")) continue;
              const payload = line.slice(5).trim();
              if (payload === "[DONE]") {
                setIsLoading(false);
                abortRef.current = null;
                return;
              }
              try {
                const obj = JSON.parse(payload);
                if (obj.error) {
                  setIsLoading(false);
                  setMessages(prev => [...prev, { role: "assistant", content: `⚠️ ${obj.error}` }]);
                  abortRef.current = null;
                  return;
                }
                if (obj.token) {
                  ai += obj.token;
                  setMessages(prev => {
                    const out = [...prev];
                    for (let i = out.length - 1; i >= 0; i--) {
                      if (out[i].role === "assistant") {
                        out[i] = { ...out[i], content: ai };
                        break;
                      }
                    }
                    return out;
                  });
                }
              } catch { /* abaikan non-JSON */ }
            }
          }

          setIsLoading(false);
          abortRef.current = null;
        } catch (err) {
          setIsLoading(false);
          abortRef.current = null;
          setMessages(prev => [...prev, { role: "assistant", content: `⚠️ Gagal memuat: ${err?.message || err}` }]);
        }
      }

      return (
        <div className="app">
          <header>
             <h1 style={{ display: "flex", alignItems: "center", gap: "10px" }}>
    Troppion Chatbot AI
    <a href="index.html" className="ghost">⬅️ Kembali</a>
  </h1>
            <div className="actions">
              <label style={{opacity: .9}}>
                Gaya:&nbsp;
                <select value={style} onChange={(e) => setStyle(e.target.value)} className="ghost">
                  <option value="comprehensive">Menyeluruh</option>
                  <option value="concise">Ringkas</option>
                </select>
              </label>

              {/* input file */}
              <label className="ghost" style={{ cursor: "pointer" }}>
                📎 Gambar
                <input
                  type="file"
                  accept="image/png,image/jpeg,image/webp"
                  multiple
                  onChange={onPickFiles}
                  className="ghost"
                  style={{ display: "none" }}
                />
              </label>

              {isLoading && (
                <button type="button" onClick={stopStreaming} className="ghost" title="Hentikan streaming">
                  ⏹️ Stop
                </button>
              )}
            </div>
          </header>

          {/* preview gambar terpilih */}
          {files.length > 0 && (
            <div style={{ padding: "8px 16px", display: "flex", gap: 8, flexWrap: "wrap" }}>
              {files.map((f, i) => (
                <Preview key={i} file={f} onRemove={() => removeFile(i)} />
              ))}
            </div>
          )}

          <div className="shell"><div className="panel">
            <main ref={listRef} className="chat">
              {messages.map((m, i) => <Message key={i} role={m.role} content={m.content} />)}
              {isLoading && <div className="typing"><span className="dot"></span><span className="dot"></span><span className="dot"></span><span>AI sedang menganalisis</span></div>}
            </main>
          </div></div>

          <form onSubmit={sendMessage} className="input">
            <input
              autoFocus
              value={input}
              onChange={(e) => setInput(e.target.value)}
              placeholder="Tulis pertanyaan… (bisa lampirkan gambar)"
              type="text"
            />
            <button type="submit" disabled={isLoading || (!input.trim() && files.length === 0)}>
              Kirim
            </button>
          </form>
        </div>
      );
    }

    function Message({ role, content }) {
      const html = { __html: window.marked.parse(content || "") };
      return (
        <div className={`msg ${role}`}>
          <div className="avatar">{role === "assistant" ? "🤖" : "🧑"}</div>
          <div className="bubble">
            <div className="content" dangerouslySetInnerHTML={html} />
          </div>
        </div>
      );
    }

    function Preview({ file, onRemove }) {
      const [url, setUrl] = useState("");
      useEffect(() => {
        const u = URL.createObjectURL(file);
        setUrl(u);
        return () => URL.revokeObjectURL(u);
      }, [file]);
      return (
        <div style={{
          position: "relative", width: 96, height: 96, borderRadius: 12, overflow: "hidden",
          border: "1px solid var(--border)", background: "#0b1222"
        }}>
          <img src={url} alt={file.name} style={{ width: "100%", height: "100%", objectFit: "cover" }} />
          <button
            type="button"
            onClick={onRemove}
            title="Hapus"
            style={{
              position: "absolute", top: 6, right: 6, border: "none", borderRadius: 8,
              padding: "4px 6px", fontSize: 12, cursor: "pointer",
              background: "rgba(0,0,0,.5)", color: "#eee"
            }}
          >
            ✕
          </button>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
